name: marketplace-smoke

on:
  workflow_dispatch:
  push:
    branches: [main]





permissions:
  contents: read
  actions: read

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare inputs (deterministic)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p .verifrax
          # minimal SPDX SBOM (valid JSON)
          cat > .verifrax/sbom.spdx.json <<'JSON'
          {
            "spdxVersion": "SPDX-2.3",
            "SPDXID": "SPDXRef-DOCUMENT",
            "name": "verifrax-marketplace-smoke",
            "dataLicense": "CC0-1.0",
            "documentNamespace": "https://verifrax.net/spdx/smoke",
            "creationInfo": {
              "created": "2024-01-01T00:00:00Z",
              "creators": ["Tool: verifrax-marketplace-smoke"]
            },
            "packages": []
          }
          JSON
          python3 -c "import json; json.load(open('.verifrax/sbom.spdx.json'))"
          # shadow at repo root
          echo '== FORCE POLICY (CURRENT SCHEMA) =='
          cat > .verifrax/policy.json <<'JSON'
          {
            "version": "v1",
            "rules": [
              {
                "id": "SMOKE_ALWAYS_PASS",
                "level": "fail",
                "require": [
                  { "path": "artifact_hash", "op": "exists" }
                ]
              }
            ]
          }
          JSON
          python3 -c "import json; json.load(open('.verifrax/policy.json'))"
          node -e "JSON.parse(require('fs').readFileSync('.verifrax/policy.json','utf8')); console.log('NODE_POLICY_OK_AFTER_FORCE')"

          node -e "JSON.parse(require('fs').readFileSync('.verifrax/policy.json','utf8')); console.log('NODE_POLICY_OK_AFTER_FORCE')"

          cp -f .verifrax/policy.json ./policy.json
          cp -f .verifrax/sbom.spdx.json ./sbom.spdx.json
          ls -la .verifrax || true
          wc -c .verifrax/policy.json .verifrax/sbom.spdx.json || true

      - name: CICULLIS smoke
        uses: Verifrax/cicullis@v0
        with:
          mode: pass

      - name: VERIFRAX smoke
        uses: Verifrax/VERIFRAX@8d7571fda2965477f2172e60ac4f0c8948fbdec0
        with:
          mode: audit
          policy_path: ${{ github.workspace }}/policy.json
          sbom_path: ${{ github.workspace }}/sbom.spdx.json
          out_path: ${{ github.workspace }}/verifrax.seal.json

      - name: Print seal head
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          ls -la || true
          test -s verifrax.seal.json && head -n 60 verifrax.seal.json || true
