name: marketplace-smoke

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare inputs (deterministic)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p .verifrax

          # fetch canonical policy JSON from VERIFRAX@v1 (raw bytes)
          curl -fsSL \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.raw" \
            "https://api.github.com/repos/Verifrax/VERIFRAX/contents/policy/example.v1.json?ref=v1" \
            > .verifrax/policy.json

          # minimal SPDX SBOM (valid JSON)
          cat > .verifrax/sbom.spdx.json <<'JSON'
          {
            "spdxVersion": "SPDX-2.3",
            "SPDXID": "SPDXRef-DOCUMENT",
            "name": "verifrax-marketplace-smoke",
            "dataLicense": "CC0-1.0",
            "documentNamespace": "https://verifrax.net/spdx/smoke",
            "creationInfo": {
              "created": "2024-01-01T00:00:00Z",
              "creators": ["Tool: verifrax-marketplace-smoke"]
            },
            "packages": []
          }
          JSON

          # sanity
          test -s .verifrax/policy.json
          python3 -c "import json; json.load(open('.verifrax/policy.json'))"
          python3 -c "import json; json.load(open('.verifrax/sbom.spdx.json'))"

      - name: CICULLIS smoke
        uses: Verifrax/cicullis@v0
        with:
          mode: pass

      - name: VERIFRAX smoke
        uses: Verifrax/VERIFRAX@v1
        with:
          mode: audit
          policy_path: .verifrax/policy.json
          sbom_path: .verifrax/sbom.spdx.json
          out_path: verifrax.seal.json

      - name: Print seal head
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          ls -la || true
          test -s verifrax.seal.json && head -n 40 verifrax.seal.json || true
