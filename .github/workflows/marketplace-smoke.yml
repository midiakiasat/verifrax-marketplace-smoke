name: marketplace-smoke

"on":
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: read
  actions: read

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare inputs (deterministic)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p .verifrax

          # inline minimal policy JSON (known-good)
          cat > .verifrax/policy.json <<'JSON'
          {
            "version": "v1",
            "rules": [
              {
                "id": "SMOKE_ALWAYS_PASS",
                "when": { "always": true },
                "then": { "decision": "allow", "reason": "smoke" }
              }
            ]
          }
          JSON

          # minimal SPDX SBOM (valid JSON)
          cat > .verifrax/sbom.spdx.json <<'JSON'
          {
            "spdxVersion": "SPDX-2.3",
            "SPDXID": "SPDXRef-DOCUMENT",
            "name": "verifrax-marketplace-smoke",
            "dataLicense": "CC0-1.0",
            "documentNamespace": "https://verifrax.net/spdx/smoke",
            "creationInfo": {
              "created": "2024-01-01T00:00:00Z",
              "creators": ["Tool: verifrax-marketplace-smoke"]
            },
            "packages": []
          }
          JSON

          python3 -c "import json; json.load(open('.verifrax/policy.json'))"
          python3 -c "import json; json.load(open('.verifrax/sbom.spdx.json'))"
          node -e "JSON.parse(require('fs').readFileSync('.verifrax/policy.json','utf8')); console.log('NODE_POLICY_OK')"

          # shadow at repo root
          echo '== ROOT FILE PROBE =='
          ls -la ./policy.json ./sbom.spdx.json || true
          wc -c ./policy.json ./sbom.spdx.json || true
          python3 - <<'PY'
import binascii
b=open('policy.json','rb').read(64)
print('ROOT_POLICY_HEAD_HEX', binascii.hexlify(b).decode())
PY
          node -e "JSON.parse(require('fs').readFileSync('policy.json','utf8')); console.log('NODE_ROOT_POLICY_OK')"
          cp -f .verifrax/policy.json ./policy.json
          cp -f .verifrax/sbom.spdx.json ./sbom.spdx.json
          ls -la .verifrax || true
          wc -c .verifrax/policy.json .verifrax/sbom.spdx.json || true

      - name: CICULLIS smoke
        uses: Verifrax/cicullis@v0
        with:
          mode: pass

      - name: VERIFRAX smoke
        uses: Verifrax/VERIFRAX@v1
        with:
          mode: audit
          policy_path: ${{ github.workspace }}/policy.json
          sbom_path: ${{ github.workspace }}/sbom.spdx.json
          out_path: ${{ github.workspace }}/verifrax.seal.json

      - name: Print seal head
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          ls -la || true
          test -s verifrax.seal.json && head -n 60 verifrax.seal.json || true
